<style>

    header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: -webkit-linear-gradient(
        to right, #986c4a,
                #9d5218);
        background: linear-gradient(
            to right, #b57747,
                #5e3211);
        color: white;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
        padding: 0 2px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
    }

    body {
        height: auto;
        background: #f7f5e9;
        margin: 0;
        overflow: hidden;
        overflow-y: scroll;
        font-family: 'Work Sans', sans-serif;
    }

    .capa-livro {
        display: block;
        width: 100%;
        aspect-ratio: 2/3;
        object-fit: cover;
        background-color: #eee;
        border-radius: 6px;
        box-shadow: 0 12px 10px #986c4a;
    }

    .div-capa {
        background: -webkit-linear-gradient(
        to right, #FBF2C0,
                #986c4a);
        background: linear-gradient(
            to right, #FBF2C0,
                #e38f50);
        border-radius: 10px;
        box-shadow: 0 6px 10px rgba(0,0,0,0.6);
        overflow: hidden;
        width: 23rem;
        height: 27rem;
        margin-left: 10%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .capa-livro {
        width: 15rem;
        margin: 1.5rem;
        /* margin-left: 5rem; */
    }

    .livro {
        display: flex;
        /* justify-content: space-between; */
        gap: 20px;
        margin-top: 60px;
        width: 100%;
    }

    .descricao-livro {
        display: flex;
        gap: 20px;
        font-size: 1rem;
        /* width: 100%; */
    }

    .titulo {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .titulo-livro {
        font-size: 3rem;
        margin: 0;    
    }

    .montserrat {
        font-family: "Montserrat", sans-serif;
        font-optical-sizing: auto;
        font-weight: 600;
        font-style: normal;
    }

    .infos-livro {
        width: 40%;
    }

    .container-categoria {
        margin-top: 60px;
        width: 100%;
        padding: 0.1rem;
        background-color: lightgray;
    }

    .categoria {
        margin-left: 3%;
        color: #C06E52;
    }

    .container-estrelas-avaliacao {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.2rem;
    }

    #estrelas-avaliacao .fa-star,
    #estrelas-avaliacao .fa-star-half-alt {
        color: #f8ce0b;
    }

    #estrelas-avaliacao .far.fa-star {
        color: #ddd;
    }

    .botoes {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        width: 20rem;
    }

    .botoes p{
        margin: 0;
    }

    .botoes button{
        border-radius: 20px;
        background-color: #C06E52;
        color: #FBF2C0;
        padding: 0.2rem 2rem;
    }

    .btn-favorito {
        cursor: pointer;
        font-size: 1.5rem;
        color: #ccc;
    }

    .btn-favorito .fas.fa-heart {
        color: #e74c3c;
    }

    .conteudo-body {
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }

    .mostrar {
        opacity: 1;
    }

    .d-none {
        display: none !important;
    }

    .container-avaliacoes {
        margin: 5%;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .texto-avaliacoes {
        cursor: pointer;
    }

    .container-user-avaliacao {
        width: 50%;
    }

    #user-avaliacao {
        width: 100%;
    }

    .form-button {
        background-color: #986c4a;
        color: #f7f5e9;
        white-space: nowrap;
        border: none;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 0.5rem;
        line-height: 3.125rem;
        outline: none;
        font-size: 1.125rem;
        letter-spacing: .025rem;
        text-decoration: none;
        cursor: pointer;
        font-weight: 800;
        min-height: 3.125rem;
        min-width: 30%;
        width: fit-content;
        border-radius: 0.75rem;
        transition: all .3s ease;
        -webkit-transition: all .3s ease;
    }

    .form-button:hover {
        background-color: #784b28;
        box-shadow: 2px 2px 30px #b57747;
    }

</style>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>
<body>

    <!-- <header>
        <nav>
            <button id="btn-home">Voltar</button>
        </nav>
        <h2>Biblioteca</h2>
    </header> -->

    <div id="header-container"></div>
    <div id="navbar-container"></div>

    <div class="conteudo-body">
        <div class="container-categoria">
            <p class="categoria"></p>
        </div>

        <div class="livro">
            <div class="div-capa">
                <div class="bg-capa">
                    <img id="capa-livro" class="capa-livro" src="" alt="">
                </div>
            </div>
            <div class="infos-livro">
                <div class="titulo">
                    <h3 class="titulo-livro montserrat"></h3>
                    <span class="btn-favorito"><i id="i-favorito" class="far fa-heart"></i></span>
                </div>
                <div class="container-estrelas-avaliacao">
                    <div id="estrelas-avaliacao"></div>
                    <div class="descricao-livro">
                        <a href="" id="editora-livro"></a>
                        <a href="" id="autor-livro"></a>
                    </div>
                </div>
            
                <p id="sinopse-livro"></p>
            </div>
            <div class="botoes">
                <p class="disponivel"></p>
                <button type="button" id="btn-reserva" class="form-button">Reservar</button>
                <button type="button" id="btn-lista-espera" class="form-button d-none">Lista de Espera</button>
            </div>
        </div>

        <div class="container-avaliacoes">

            <div class="container-user-avaliacao">
                <textarea name="user-avaliacao" id="user-avaliacao" rows="5"></textarea>
                <button type="button" id="btn-avaliar">Avaliar</button>
            </div>

            <span class="texto-avaliacoes">Avaliações <i class="fa fa-chevron-down"></i></span>
            <div class="container-users-avaliacoes d-none"></div>
        </div>
    </div>
    
</body>
</html>

<script src="./js/jquery.min.js"></script>
<script src="js/config.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
<script>
    
    $(document).ready(function() {
        const token = localStorage.getItem("jwtToken");

        if (!token) {
            alert('Você não está logado! Redirecionando para o login.');
            window.location.href = '/login.html';
        }

        const decodedPayload = jwt_decode(token);
        const role = decodedPayload.role;

        $("#navbar-container").load("template/navbar.html", function() {
            atualizaRoleNavbar(role);
        });
        $("#header-container").load("template/header.html", function() {
            atualizaRoleHeader(role);
        });

        const queryString = window.location.search;

        const urlParams = new URLSearchParams(queryString);

        const API_BASE = `${API_URL}/livros`;
        const id = urlParams.get('id');

        const API_LIVRO = `${API_BASE}/${id}`;

        const card = $("#capa-livro");

        let categoria;

        fetch(API_LIVRO, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        }).then(response => {
            
            return response.json()

        }).then(data => {
            categoria = data.categoria;
            $(".categoria").text(categoria);

            const promises = [];

            const urlCapa = `${API_BASE}/${id}/capa`;

            const promise = fetch(urlCapa, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(response => {
                if(!response.ok) {
                    throw new Error('Não foi possível carregar a capa.');
                }

                return response.blob();
            }).then(blob => {   
                const objectURL = URL.createObjectURL(blob);

                card.attr('src', objectURL)
                console.log(data);

                $(".titulo-livro").text(data.titulo);
                $("#editora-livro").text(data.editora);
                $("#autor-livro").text(data.autor);
                $("#sinopse-livro").text(data.sinopse);

                if(data.qtd_disponivel) {
                    $(".disponivel").text(`Na prateleira: ${data.qtd_disponivel}`);
                } else {
                    $("#btn-reserva").addClass("d-none");
                    $("#btn-lista-espera").removeClass("d-none");
                }
 
            }).catch(error => {
                console.error(`Erro ao carregar capa para o ISBN ${isbn}:`, error);
                
                card.attr('src', 'caminho/para/imagem_padrao.png');
            });

            promises.push(promise);

            return Promise.all(promises);

        }).then(() => {
            $(".conteudo-body").addClass("mostrar");

            let totalNotas = 0;
            let totalAvaliacoes = 0;

            fetch(`${API_URL}/avaliacao?idLivro=${id}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(async response => {
                return await response.json();

            }).then(avaliacoes => {
                avaliacoes.forEach(avaliacao => {
                    console.log(avaliacao);
                    totalNotas += avaliacao.avaliacao;
                    totalAvaliacoes++;
                    $(".container-users-avaliacoes").append(`   <div id="avaliacao-${avaliacao.id}">
                                                                    <span id="info-user-avaliacao">${avaliacao.usuario.nome.split(' ')[0]} - ${avaliacao.avaliacao}</span>
                                                                    <span id="info-user-comentario">${avaliacao.comentario}</span>
                                                                </div>`);
                });

                let mediaAvaliacao = 0;
                if(totalAvaliacoes > 0) {
                    mediaAvaliacao = Math.round(totalNotas / totalAvaliacoes);
                }

                renderizarEstrelas(mediaAvaliacao);
                
            })

        });

        $("#btn-home").on("click", function() {
            window.location.href = `exibeLivros.html?categoria=${categoria}`;
        });

        // $(".botao-reserva").on("click", function() {
        //     alert('boa garoto')
        // });

        function renderizarEstrelas(mediaAvaliacao) {
            const containerEstrelas = $("#estrelas-avaliacao");
            containerEstrelas.empty();

            for(let i=1; i<= 5; i++) {
                const starIcon = document.createElement('i');

                if(i <= mediaAvaliacao) {
                    starIcon.className = 'fas fa-star estrela-preenchida';

                } else {
                    starIcon.className = 'far fa-star'
                }

                $("#estrelas-avaliacao").append(starIcon);
            }
        }

        $(".btn-favorito").on("click", function() {
            let classeFavorito = $(".btn-favorito")[0].children[0].className;
            let API_FAVORITO;
            const idLivro = id;

            if(classeFavorito.includes("far")) {
                $("#i-favorito").addClass("fas").removeClass("far");
                API_FAVORITO = `${API_URL}/favoritos/favoritar`;

            } else if(classeFavorito.includes("fas")) {
                $("#i-favorito").addClass("far").removeClass("fas");
                API_FAVORITO = `${API_URL}/favoritos/retirar-favorito`;
            }

            fetch(API_FAVORITO, {
                method: 'POST',
                headers: { "Content-Type": "application/json",
                    'Authorization': `Bearer ${token}`    
                },
                body: JSON.stringify(idLivro)
            });
        })

        // renderizarEstrelas();

        $("#btn-reserva").on("click", () => {
            $(document).trigger('header:toggleCart', [id]);

            // fetch(`${API_URL}/reserva/${id}`, {
            //     method: 'POST',
            //     headers: { "Content-Type": "application/json",
            //         'Authorization': `Bearer ${token}`
            //     }
            // }).then(response => {
            //     if(!response.ok) {
            //         throw new Error('Não foi possível reservar este livro');
            //     } else {
            //         alert('livro reservado');
            //     }

            //     // return response.blob();
            // });

            // let qtdDisponivel = parseInt($(".disponivel").text().split(':')[1].trim());
            // qtdDisponivel = qtdDisponivel - 1;

            // $(".disponivel").text(`Na prateleira: ${qtdDisponivel}`);
        });

        $("#btn-lista-espera").on("click", function() {
            fetch(`${API_URL}/reserva/${id}/lista-espera`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(() => {
                $("#btn-lista-espera").addClass("d-none");
            })
        }); 

        $("#btn-avaliar").on("click", function() {
            const avaliacao = {
                'avaliacao': 5,
                'comentario': $("#user-avaliacao").val(),
                'livro': {
                    'id': id,   
                }
            };

            fetch(`${API_URL}/avaliacao`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`},
                body: JSON.stringify(avaliacao)

            }).then(() => {
                alert('Avaliação gravada')

            });
        })

        $(".texto-avaliacoes").on("click", function() {
            $(".container-users-avaliacoes").hasClass("d-none") ? $(".container-users-avaliacoes").removeClass("d-none") : $(".container-users-avaliacoes").addClass("d-none");
            
        });

    })

</script>