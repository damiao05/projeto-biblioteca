<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Menu - Usuário</title>

<style>
    html {
        overflow-x: hidden;
    }

    body {
        font-size: 16px;
        font-family: 'Work Sans', sans-serif;
        min-height: 100vh;
        background: linear-gradient(to right, #b57747, #5e3211);
        margin: 0;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* ============================
       CENTRALIZAÇÃO DO CONTEÚDO
    ============================= */
    main {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);

        width: 100%;
        height: auto;

        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* ============================
       CARD DO PERFIL
    ============================= */
    .form-editar {
        display: flex;
        flex-direction: column;
        width: 60%;
        max-width: 900px;

        background: #f7f5e9;
        border-radius: 15px;
        box-shadow: 8px 8px 90px #13162a;

        padding: 40px 0;
        justify-content: center;
        align-items: center;
    }

    .container-infos {
        padding: 5%;
        width: 80%;
    }

    /* ============================
       CAMPOS DO PERFIL (MESMO ESTILO DO LOGIN)
    ============================= */
    .input__wrapper {
        position: relative;
        padding: 0.9375rem 0 0;
        margin-bottom: 2rem;
    }

    .input__field {
        font-size: 1.4rem;
        color: #13162a;
        padding: 0.375rem 0;
        padding-bottom: 0.7rem;
        line-height: 2rem;
        height: 2rem;
        outline: 0;
        border: 0;
        width: 100%;
        border-bottom: 3px solid #13162a;
        background: transparent;
        transition: all 0.3s ease;
    }

    .disabled {
        pointer-events: none;
        opacity: 0.7;
    }

    .input__field::placeholder {
        color: transparent;
    }

    .input__label {
        user-select: none;
    }

    .input__field:placeholder-show ~ .input__label {
        cursor: text;
        color: #13162a;
        top: 0.8rem;
        font-size: 1.2rem;
    }

    .input__label,
    .input__field:focus ~ .input__label {
        position: absolute;
        top: -0.8rem;
        display: block;
        font-size: 1.2rem;
        color: #13162a;
        transition: 0.3s;
    }

    .input__field:focus ~ .input__label {
        color: #986c4a;
    }

    .input__field:focus {
        border-bottom: 3px solid #986c4a;
    }

    /* ============================
       BOTÕES
    ============================= */
    button {
        cursor: pointer;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: bold;
        font-size: 1rem;
        transition: 0.3s;
        margin-top: 10px;
    }

    #btn-editar {
        background: #986c4a;
        color: #fff;
    }

    #btn-editar:hover {
        background: #784b28;
        box-shadow: 2px 2px 20px #b57747;
    }

    #btn-salvar {
        background: #4caf50;
        color: white;
    }

    #btn-salvar:hover {
        background: #3e8e41;
    }

    #btn-deletar-conta {
        background: #b81c1c;
        color: white;
    }

    #btn-deletar-conta:hover {
        background: #8c0f0f;
    }

    .d-none {
        display: none;
    }
</style>
</head>

<body>

    <div id="header-container"></div>
    <div id="navbar-container"></div>

    <main>
        <form class="form-editar">
            <div class="container-infos">

                <div class="input__wrapper">
                    <input type="text" id="perfil-nome" class="input__field disabled">
                    <label class="input__label">Nome Completo</label>
                </div>

                <div class="input__wrapper">
                    <input type="text" id="perfil-cpf" class="input__field disabled">
                    <label class="input__label">CPF</label>
                </div>

                <div class="input__wrapper">
                    <input type="text" id="perfil-dt-nascimento" class="input__field disabled" placeholder="__/__/____">
                    <label class="input__label">Data de Nascimento</label>
                </div>

                <div class="input__wrapper">
                    <input type="text" id="perfil-telefone" class="input__field disabled">
                    <label class="input__label">Telefone</label>
                </div>

                <div class="input__wrapper">
                    <input type="email" id="perfil-email" class="input__field disabled">
                    <label class="input__label">Email</label>
                </div>
            </div>

            <button type="button" id="btn-editar">Editar</button>
            <button type="button" id="btn-salvar" class="d-none">Salvar</button>
            <button type="button" id="btn-deletar-conta">Excluir Perfil</button>
        </form>
    </main>

    <script src="./js/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
    <script src="js/config.js"></script>

<script>
    function formataDataParaUsuario(data) {
        data = data.split('-');
        return `${data[2]}/${data[1]}/${data[0]}`;
    }

    function formataDataParaBanco(data) {
        data = data.split('/');
        return `${data[2]}-${data[1]}-${data[0]}`;
    }

    function formatarTelefone(t) {
        return t.length === 11 ? `(${t.slice(0,2)})${t.slice(2)}` : t;
    }

    $(document).ready(function () {

        let id;
        const token = localStorage.getItem("jwtToken");
        const decoded = jwt_decode(token);

        $("#navbar-container").load("template/navbar.html", () => atualizaRoleNavbar(decoded.role));
        $("#header-container").load("template/header.html", () => atualizaRoleHeader(decoded.role));

        const API_PERFIL = `${API_URL}/usuarios/meu-perfil`;

        fetch(API_PERFIL, {
            headers: { "Authorization": `Bearer ${token}` }
        })
        .then(r => r.json())
        .then(usuario => {
            id = usuario.id;
            $("#perfil-nome").val(usuario.nome);
            $("#perfil-cpf").val(usuario.cpf);
            $("#perfil-dt-nascimento").val(formataDataParaUsuario(usuario.dataNascimento));
            $("#perfil-telefone").val(formatarTelefone(usuario.telefone));
            $("#perfil-email").val(usuario.email);
        });

        $("#btn-editar").click(() => {
            $(".input__field").removeClass("disabled");
            $("#btn-editar").addClass("d-none");
            $("#btn-salvar").removeClass("d-none");
        });

        $("#btn-salvar").click(() => {

            const dados = {
                nome: $("#perfil-nome").val(),
                cpf: $("#perfil-cpf").val(),
                dataNascimento: formataDataParaBanco($("#perfil-dt-nascimento").val()),
                telefone: $("#perfil-telefone").val(),
                email: $("#perfil-email").val()
            };

            fetch(API_PERFIL, {
                method: "PUT",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(dados)
            });

            $(".input__field").addClass("disabled");
            $("#btn-salvar").addClass("d-none");
            $("#btn-editar").removeClass("d-none");
        });

        $("#btn-deletar-conta").click(() => {
            fetch(`${API_URL}/usuarios/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            }).then(() => {
                localStorage.clear();
                window.location.href = "index.html";
            });
        });
    });
</script>

</body>
</html>
