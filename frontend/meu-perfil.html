<style>

    /* header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background-color: #986c4a;
        color: white;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
        padding: 0 2px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
    } */
    html {
        overflow-x: hidden;
        overflow-y: hidden;
    }

    body {
        font-size: 16px;
        font-family: 'Work Sans', sans-serif;
        min-height: 100vh;
        background: -webkit-linear-gradient(
            to right, #986c4a,
                    #9d5218
        );
        background: linear-gradient(
            to right, #b57747,
                    #5e3211
        );
        margin-top: 60px;
    }

    * {
        margin: 0;
        padding: 0;
    }

    main {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        margin-top: -60px;
    }

    .user-infos {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .user-infos input {
        border-radius: 5px;
        padding: 6px;
    }

    .disabled {
        pointer-events: none;
        background-color: lightgray;
    }

    .d-none {
        display: none;
    }

    .form-editar {
        /* margin-top: 60px; */
        display: flex;
        flex-direction: column;
        width: 60%;
        height: 80%;
        background: #f7f5e9;
        z-index: 5001;
        border-radius: 15px;
        justify-content: center;
        align-items: center;
    }

    .input__wrapper {
        position: relative;
        padding: 0.9375rem 0 0;
        margin-bottom: 2rem;
    }

    .input__field {
        font-size: 1.4rem;
        color: #13162a;
        padding: 0.375rem 0;
        padding-right: 2rem;
        padding-bottom: 0.5rem;
        line-height: 2rem;
        height: 2rem;
        outline: 0;
        border: 0;
        width: 100%;
        vertical-align: middle;
        padding-bottom: 0.7rem;
        border-bottom: 3px solid #13162a;
        background: transparent;
        transition: border-color 0.2s;
    }

    .input__field::placeholder {
        color: transparent;
    }

    .input__label {
        user-select: none;
    }

    .input__field:placeholder-show~.input__label {
        cursor: text;
        color: #13162a;
        top: 0.8rem;
        font-size: 1.2rem;
    }

    .input__label,
    .input__field:focus~.input__label {
        position: absolute;
        top: -0.8rem;
        display: block;
        font-size: 1.2rem;
        color: #13162a;
        transition: 0.3s;
    }

    .input__field:focus~.input__label {
        color: #986c4a;
    }

    .input__field:focus {
        border-bottom: 3px solid #986c4a;
    }

    .container-infos {
        padding: 5%;
        width: 80%;
        height: 65%;
    }

</style>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Usuário</title>
</head>
<body>
    <div id="header-container"></div>
    <div id="navbar-container"></div>

    <main>
        <form class="form-editar">
            <div class="container-infos">
                <div class="input__wrapper">
                    <input type="text" name="perfil-nome" id="perfil-nome" class="input__field disabled">
                    <label for="perfil-nome" class="input__label">Nome Completo</label>
                </div>
                <div class="input__wrapper">
                    <input type="text" name="perfil-cpf" id="perfil-cpf" class="input__field disabled">
                    <label for="perfil-cpf" class="input__label">CPF</label>
                </div>
                <div class="input__wrapper">
                    <input type="text" name="perfil-dt-nascimento" id="perfil-dt-nascimento" placeholder="__/__/____" class="input__field disabled">
                    <label for="perfil-dt-nascimento" class="input__label">Data de Nascimento</label>
                </div>
                <div class="input__wrapper">
                    <input type="text" name="perfil-telefone" id="perfil-telefone" class="input__field disabled">
                    <label for="perfil-telefone" class="input__label">Telefone</label>
                </div>
                <div class="input__wrapper">
                    <input type="email" name="perfil-email" id="perfil-email" class="input__field disabled">
                    <label for="perfil-email" class="input__label">Email</label>
                </div>
                <!-- <div class="input__wrapper">
                    <input type="text" name="senha" id="senha" class="input__field disabled">
                    <label for="senha" class="input__label">Senha</label>
                </div> -->
            </div>
            <button type="button" class="editar-infos" id="btn-editar">Editar</button>
            <button type="button" class="salvar-infos d-none" id="btn-salvar">Salvar</button>
            <button type="button" id="btn-deletar-conta">Excluir Perfil</button>
        </form>
    </main>

    <script src="./js/jquery.min.js"></script>
    <!-- <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>  -->
     <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
     <script src="js/config.js"></script>
    <!-- <script src="./js/seu-script.js"></script> -->
</body>
</html>

<script>

    function formataDataParaUsuario(data) {
        data = data.split('-');
        return `${data[2]}/${data[1]}/${data[0]}`;
    }

    function formataDataParaBanco(data) {
        data = data.split('/');
        return `${data[2]}-${data[1]}-${data[0]}`;
    }

    function formatarTelefone(telefone) {
        if(telefone.length == 11) {
            return `(${telefone.slice(0, 2)})${telefone.slice(2, 11)}`;
        }

        return telefone;
    }

    $(document).ready(function() {

        let infosUsuario;
        let id;

        const urlAnterior = sessionStorage.getItem('urlAnterior');

        const token = localStorage.getItem('jwtToken');
        const decodedPayload = jwt_decode(token);

        const role = decodedPayload.role;

        $("#navbar-container").load("template/navbar.html", function() {
            atualizaRoleNavbar(role);
        });
        $("#header-container").load("template/header.html", function() {
            atualizaRoleHeader(role);
        });

        if (!token) {
            alert('Você não está logado! Redirecionando para o login.');
            window.location.href = '/login.html';
        }

        const API_BASE = `${API_URL}/usuarios`;
        const API_PERFIL = `${API_BASE}/meu-perfil`;

        fetch(API_PERFIL, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        }).then(response => {
            if (response.status === 403) {
                localStorage.clear();
                window.location.href = '/login.html';
                throw new Error('Sessão inválida.');
            }
            if (!response.ok) {
                throw new Error('Não foi possível carregar os dados do perfil.');
            }
            return response.json();
        }).then(usuario => {
            infosUsuario = usuario;
            id = usuario.id;
            $("#perfil-nome").val(usuario.nome);
            $("#perfil-cpf").val(usuario.cpf);  
            $("#perfil-dt-nascimento").val(formataDataParaUsuario(usuario.dataNascimento));
            $("#perfil-telefone").val(usuario.telefone ? formatarTelefone(usuario.telefone) : '');
            $("#perfil-email").val(usuario.email);

        }).catch(error => {
            console.error('Erro ao buscar perfil:', error);
            alert(error.message);
        });

        $("#btn-editar").on("click", function() {
            $("#perfil-nome").removeClass("disabled");
            $("#perfil-cpf").removeClass("disabled");
            $("#perfil-dt-nascimento").removeClass("disabled");
            $("#perfil-telefone").removeClass("disabled");
            $("#perfil-email").removeClass("disabled");
            $("#btn-salvar").removeClass("d-none");
            $("#btn-editar").addClass("d-none");
            // $("#senha").removeClass("disabled");
        });

        $("#btn-salvar").on("click", function() {
            const infosForm = {
                nome: $("#perfil-nome").val(),
                cpf: $("#perfil-cpf").val(),
                dataNascimento: formataDataParaBanco($("#perfil-dt-nascimento").val()),
                telefone: $("#perfil-telefone").val(),
                email: $("#perfil-email").val(),
                // senha: $("#senha").val()
            };

            $("#perfil-nome").addClass("disabled");
            $("#perfil-cpf").addClass("disabled");
            $("#perfil-dt-nascimento").addClass("disabled");
            $("#perfil-telefone").addClass("disabled");
            $("#perfil-email").addClass("disabled");
            // $("#senha").addClass("disabled");
            $("#btn-salvar").addClass("d-none");
            $("#btn-editar").removeClass("d-none");

            fetch(API_PERFIL, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(infosForm)
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Não foi possível atualizar os dados do perfil.');
                } else {
                    alert('Dados atualizados com sucesso');
                }
            });

        });

        $("#btn-voltar").on("click", function() {
            window.location.href = urlAnterior;
        });

        $("#btn-deletar-conta").on("click", function() {
            fetch(`${API_URL}/usuarios/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(() => {
                localStorage.removeItem("carrinhoLivros");
                window.location.href = 'index.html';
            })
        });

    });

</script>