<style>

    header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background-color: #986c4a;
        color: white;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
        padding: 0 2px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
    }

    body {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f7f5e9;
        margin: 0;
    }

    #btn-carregar-usuarios {
        border-radius: 1rem;
    }

    #formCadastroLivro {
        display: flex;
        /* justify-content: space-between; */
        gap: 20px;
        margin-top: 60px;
        width: 100%;
        margin-left: 5rem;
        margin-right: 5rem;
    }

    .container-informacoes {
        display: flex;
        flex-direction: column;
        width: 50%;
    }

    .container-sinopse {
        display: flex;
        flex-direction: column;
        width: 20%
    }

    .container-capa {
        width: 30%;
    }

    #formCadastroLivro label {
        font-weight: bold;
        text-align: center;
    }

    #formCadastroLivro input,
    #formCadastroLivro button {
        padding: 6px;
    }

    .drop-zone {
        width: 100%;
        height: 100%;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        border: 3px dashed #986c4a;
        border-radius: 10px;
        background-color: #f7f5e9;
        cursor: pointer;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .drop-zone-input {
        display: none;
    }

    .drop-zone-prompt {
        color: #999;
    }

    .drop-zone--over {
        border-style: solid;
        background-color: #e0dccc;
    }

    .drop-zone-thumb {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        background-image: none;
    }

</style>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastrar Livro</title>

    <link href="https://releases.transloadit.com/uppy/v3.21.0/uppy.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <nav>
            <button id="btn-home">Voltar</button>
        </nav>
        <h2>Biblioteca</h2>
    </header>

    <form id="formCadastroLivro" class="dropzone">
        <div class="container-capa">
            <!-- <div class="drop-zone" id="dropZone">
                <span class="drop-zone-prompt">Arraste a imagem da capa aqui, ou clique para selecionar</span>
                <input type="file" name="file" id="file" class="drop-zone-input" accept="image/*" required>
                <div class="drop-zone-thumb" style="display: none;"></div>
            </div> -->
        </div>
        <div class="container-informacoes">
            <label for="isbn">ISBN</label>
            <input type="text" name="isbn" id="isbn" required>
            <label for="titulo">Título</label>
            <input type="text" name="titulo" id="titulo">
            <label for="autor">Autor</label>
            <input type="text" name="autor" id="autor">
            <label for="categoria">Categoria</label>
            <input type="text" name="categoria" id="categoria">
            <label for="editora">Editora</label>
            <input type="text" name="editora" id="editora">
        </div>
        <div class="container-sinopse">
            <label for="sinopse">Sinopse</label>
            <textarea name="sinopse" id="sinopse" rows="5"></textarea>
            <button type="submit">Salvar</button>
        </div>  
    </form>
</body>
</html>

<script src="./js/jquery.min.js"></script>
<script>

    $(document).ready(function() {

        const urlAnterior = sessionStorage.getItem('urlAnterior');

        const token = localStorage.getItem("jwtToken");

        if (!token) {
            alert('Você não está logado! Redirecionando para o login.');
            window.location.href = '/login.html';
        }

        const { Uppy, Dashboard, XHRUpload, pt_BR } = Uppy.Core;

        const uppy = new Uppy({
            debug: true,
            autoProceed: false,
            locale: pt_BR,
            restriction: {
                maxNumberOfFiles: 1,
                allowedFileTypes: ['image/jpeg', 'image/png', 'image/webp']
            }
        });

        uppy.use(Dashboard, {
            inline: true,
            target: '.container-capa',
            height: 400,
            showProgressDetails: true,
            note: 'Apenas imagens (JPEG, PNG e WEBP). 1 arquivo no máximo.'
        });

        uppy.use(XHRUpload, {
            endpoint: 'http://localhost:8080/livros',
            method: 'POST',
            fieldName: 'file',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });


        uppy.on('upload-prepare', (file) => {
            const livro = {
                isbn: $("#isbn").val().trim(),
                titulo: $("#titulo").val(),
                autor: $("#autor").val(),
                categoria: $("#categoria").val(),
                editora: $("#editora").val(),
                sinopse: $("#sinopse").val()
            };

            uppy.setFileMeta(file.id, {
                livro: new Blob([JSON.stringify(livro)], { type: "application/json" })
            });
        })

        $("#formCadastroLivro").on("submit")

        

        const API_BASE = "http://localhost:8080";

        $("#formCadastroLivro").on("submit", async (e) => {
            e.preventDefault();
            const fileInput = $("#file")[0];
            const livroIsbn = $("#isbn").val().trim();

            if(!fileInput.files.length) return alert("Adicione uma capa");

            const livro = {
                isbn: $("#isbn").val().trim(),
                titulo: $("#titulo").val(),
                autor: $("#autor").val(),
                categoria: $("#categoria").val(),
                editora: $("#editora").val(),
                sinopse: $("#sinopse").val()
            }

            const formData = new FormData();

            formData.append("file", fileInput.files[0]);
            formData.append('livro', new Blob([JSON.stringify(livro)], {
                type: "application/json"
            }));

            fetch('http://localhost:8080/livros', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            }).then(() => {
                alert("Livro cadastrado!");
            });


        });

        $("#btn-home").on("click", function() {
            window.location.href = urlAnterior;
        });
    });

</script>