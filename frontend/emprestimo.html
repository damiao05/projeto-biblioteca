<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empréstimo</title>

    <script src="./js/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3/build/jwt-decode.min.js"></script>

    <style>
        html {
            overflow-x: hidden;
            width: auto;
            height: auto;
        }

        body {
            width: 100%;
            height: 100%;
            font-family: 'Work Sans', sans-serif;
            font-weight: 800;
            margin: 0;
            background: -webkit-linear-gradient(
                to right, #986c4a,
                        #9d5218);
            background: linear-gradient(
                to right, #b57747,
                        #5e3211);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* O header real vem do template/header.html */
        header {
            color: #f7f5e9;
        }

        main {
            width: 100%;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 80px 0; /* espaço para não encostar no topo/baixo */
        }

        .container-informacoes {
            display: grid;
            grid-template-columns: 30% 1fr;
            grid-template-rows: auto auto;
            grid-template-areas:
                "capa infos"
                "acoes status";
            width: 80%;
            max-width: 1100px;
            min-height: 60vh;
            border-radius: 15px;
            background: #f7f5e9;
            color: #986c4a;
            box-shadow: 8px 8px 90px #13162a;
            padding: 2.5rem 2.5rem 2rem 2.5rem;
            column-gap: 2.5rem;
        }

        .container-capa {
            grid-area: capa;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .img-capa {
            width: 100%;
            max-width: 260px;
            aspect-ratio: 3/4;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 15px 50px #986c4a;
            background: #e5e2d4;
        }

        .img-capa img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .informacoes {
            grid-area: infos;
            display: flex;
            flex-direction: column;
            gap: 1.8rem;
        }

        .container-livro {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        #titulo-livro {
            font-size: 2.3rem;
            line-height: 2.5rem;
        }

        #autor-livro,
        #editora-livro {
            font-size: 1rem;
            font-weight: 600;
        }

        .container-usuario span {
            font-size: 1rem;
        }

        .container-reserva-emprestimo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .container-reserva-emprestimo span:nth-child(2) {
            font-weight: 700;
        }

        .status-emprestimo {
            grid-area: status;
            align-self: flex-end;
            justify-self: flex-end;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
            font-size: 0.95rem;
        }

        .status-emprestimo span#situacao {
            font-weight: 700;
        }

        .d-none {
            display: none !important;
        }

        /* BOTÕES DE AÇÃO */
        .acoes {
            grid-area: acoes;
            align-self: flex-end;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .acoes button {
            cursor: pointer;
            padding: 0.6rem 1.4rem;
            border-radius: 999px;
            border: none;
            font-size: 0.95rem;
            font-weight: 700;
            transition: all 0.25s ease;
        }

        #btn-registrar-emprestimo {
            background-color: #986c4a;
            color: #f7f5e9;
        }

        #btn-registrar-emprestimo:hover {
            background-color: #784b28;
            box-shadow: 2px 2px 20px #b57747;
        }

        #btn-registrar-devolucao {
            background-color: #4caf50;
            color: #f7f5e9;
        }

        #btn-registrar-devolucao:hover {
            background-color: #3e8e41;
            box-shadow: 2px 2px 20px rgba(76, 175, 80, 0.4);
        }

        #btn-cancelar-reserva {
            background-color: #b81c1c;
            color: #f7f5e9;
        }

        #btn-cancelar-reserva:hover {
            background-color: #8c0f0f;
            box-shadow: 2px 2px 20px rgba(184, 28, 28, 0.4);
        }

        @media (max-width: 900px) {
            .container-informacoes {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                grid-template-areas:
                    "capa"
                    "infos"
                    "acoes";
                row-gap: 2rem;
            }

            .status-emprestimo {
                justify-self: flex-start;
                align-items: flex-start;
                margin-top: 1rem;
            }

            .acoes {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="header-container"></div>
    <div id="navbar-container"></div>

    <main>
        <div class="container-informacoes">
            <div class="container-capa">
                <div class="img-capa">
                    <img src="" id="capa-livro">
                </div>
            </div>

            <div class="informacoes">
                <div class="container-livro">
                    <span id="titulo-livro"></span>
                    <span id="autor-livro"></span>
                    <span id="editora-livro"></span>
                </div>

                <div class="container-usuario">
                    <span id="nome-usuario"></span>
                </div>

                <div class="container-reserva-emprestimo">
                    <span id="data-reserva"></span>
                    <span>até</span>
                    <span id="data-limite-emprestimo"></span>
                </div>
            </div>

            <div class="acoes">
                <button id="btn-registrar-emprestimo">Registrar Empréstimo</button>
                <button id="btn-registrar-devolucao">Registrar Devolução</button>
                <button id="btn-cancelar-reserva" class="d-none">Cancelar Reserva</button>
            </div>

            <div class="status-emprestimo d-none">
                <span id="situacao"></span>
                <span id="dias-atraso"></span>
            </div>
        </div>
    </main>

    <script src="js/config.js"></script>

<script>
    function formataData(data) {
        data = data.split('-');
        return `${data[2]}/${data[1]}/${data[0]}`;
    }

    function calculaPrazo(paginas) {
        if (paginas <= 150) return 7;
        if (paginas <= 300) return 10;
        if (paginas <= 600) return 14;
        return 20;
    }

    function calcularPrazo(data, paginas) {
        let dataBase = new Date(data);
        dataBase.setDate(dataBase.getDate() + calculaPrazo(paginas));
        return `${dataBase.getDate()}/${(dataBase.getMonth() + 1).toString().padStart(2, '0')}/${dataBase.getFullYear()}`;
    }

    $(document).ready(function () {
        const token = localStorage.getItem('jwtToken');
        const decodedPayload = jwt_decode(token);
        const role = decodedPayload.role;

        if (role == 'CLIENTE') {
            $("#btn-registrar-emprestimo").addClass("d-none");
        }

        $("#navbar-container").load("template/navbar.html", function () {
            atualizaRoleNavbar(role);
        });
        $("#header-container").load("template/header.html", function () {
            atualizaRoleHeader(role);
        });

        if (!token) {
            alert('Você não está logado! Redirecionando para o login.');
            window.location.href = '/login.html';
        }

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        const API_EMPRESTIMO = `${API_URL}/emprestimos`;

        const reserva = urlParams.get('reserva');
        const emprestimo = urlParams.get('emprestimo');

        let livro;
        let usuario;
        let paginas;

        if (reserva) {
            $("#btn-registrar-devolucao").addClass("d-none");
            if (role == 'CLIENTE') {
                $("#btn-cancelar-reserva").removeClass("d-none");
                $("#btn-registrar-emprestimo").addClass("d-none");
            }

            const API_RESERVA = `${API_URL}/reserva?reserva=${reserva}`;

            fetch(API_RESERVA, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(async response => {
                if (!response.ok) {
                    throw new Error('Não foi possível trazer a lista de reservas.');
                }

                const listaReserva = await response.json();

                let id;
                let dataReserva;

                listaReserva.forEach(reserva => {
                    $("#titulo-livro").text(reserva.livro['titulo']);
                    $("#autor-livro").text(reserva.livro['autor']);
                    $("#editora-livro").text(reserva.livro['editora']);
                    $("#nome-usuario").text(reserva.usuario['nome']);
                    $("#data-reserva").text(formataData(reserva.dtReserva));
                    livro = reserva.livro.id;
                    usuario = reserva.usuario.id;
                    dataReserva = reserva.dtReserva.replace('-', '/');
                    paginas = reserva.livro['paginas'];

                    id = reserva.livro['id'];
                    if (reserva.status == 'CANCELADA') {
                        $("#btn-registrar-emprestimo").addClass("d-none");
                    }
                });

                $("#data-limite-emprestimo").text(calcularPrazo(dataReserva, paginas));

                const urlCapa = `${API_URL}/livros/${id}/capa`;

                return fetch(urlCapa, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Não foi possível carregar a capa.');
                    }
                    return response.blob();
                }).then(blob => {
                    const objectURL = URL.createObjectURL(blob);
                    $("#capa-livro").attr('src', objectURL);
                }).catch(error => {
                    console.error(`Erro ao carregar capa para o id ${id}:`, error);
                });

            })
        } else {
            $("#btn-registrar-emprestimo").addClass("d-none");
            if (role == 'CLIENTE') {
                $("#btn-registrar-emprestimo").addClass("d-none");
                $("#btn-registrar-devolucao").addClass("d-none");
            }

            fetch(`${API_EMPRESTIMO}/${emprestimo}/buscar`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }

            }).then(async response => {
                const dadosEmprestimo = await response.json();

                $("#titulo-livro").text(dadosEmprestimo.livro['titulo']);
                $("#autor-livro").text(dadosEmprestimo.livro['autor']);
                $("#editora-livro").text(dadosEmprestimo.livro['editora']);
                $("#nome-usuario").text(dadosEmprestimo.usuario['nome']);
                $("#data-reserva").text(formataData(dadosEmprestimo.dtEmprestimo));
                $("#data-limite-emprestimo").text(
                    dadosEmprestimo.dtDevolucaoReal
                        ? formataData(dadosEmprestimo.dtDevolucaoReal)
                        : formataData(dadosEmprestimo.dtPrevistaDevolucao)
                );
                livro = dadosEmprestimo.livro.id;
                usuario = dadosEmprestimo.usuario.id;
                paginas = dadosEmprestimo.livro['paginas'];

                $("#titulo-livro").data('id-emprestimo', dadosEmprestimo.id);

                $(".status-emprestimo").removeClass("d-none");

                let status;
                let diasAtraso;

                if (dadosEmprestimo.dtDevolucaoReal) {
                    status = 'Livro devolvido';
                    $("#btn-registrar-devolucao").addClass("d-none");
                } else {
                    const dataDevolucao = new Date(dadosEmprestimo.dtPrevistaDevolucao);
                    const dataHoje = new Date();

                    if ((dataHoje.getTime() - dataDevolucao.getTime()) > 0) {
                        status = 'Devolução em Atraso';
                        diasAtraso = Math.round(
                            (dataHoje.getTime() - dataDevolucao.getTime()) / (1000 * 60 * 60 * 24)
                        );
                        $("#dias-atraso").text(diasAtraso + " dias");
                    } else {
                        status = 'Empréstimo Ativo';
                    }
                }

                $("#situacao").text(status);

                const id = dadosEmprestimo.livro['id'];
                const urlCapa = `${API_URL}/livros/${id}/capa`;

                return fetch(urlCapa, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('Não foi possível carregar a capa.');
                    }
                    return response.blob();
                }).then(blob => {
                    const objectURL = URL.createObjectURL(blob);
                    $("#capa-livro").attr('src', objectURL);
                }).catch(error => {
                    console.error(`Erro ao carregar capa para o id ${id}:`, error);
                });
            });
        }

        $("#btn-registrar-emprestimo").on("click", function () {
            let dataHoje = new Date();
            dataHoje = `${dataHoje.getFullYear()}-${(dataHoje.getMonth() + 1).toString().padStart(2, '0')}-${dataHoje.getDate().toString().padStart(2, '0')}`;

            let dataDevolucao = calcularPrazo(dataHoje, paginas);
            dataDevolucao = dataDevolucao.split('/');
            dataDevolucao = `${dataDevolucao[2]}-${dataDevolucao[1]}-${dataDevolucao[0]}`;

            const emprestimoObj = {
                'dtEmprestimo': dataHoje,
                'dtPrevistaDevolucao': dataDevolucao,
                'usuario': { 'id': usuario },
                'livro': { 'id': livro }
            };

            fetch(API_EMPRESTIMO, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(emprestimoObj)
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Não foi possível registrar o empréstimo.');
                }
                alert('Empréstimo registrado com sucesso!');
            });
        });

        $("#btn-cancelar-reserva").on("click", function () {
            fetch(`${API_URL}/reserva/${reserva}/cancelar`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).then(() => {
                window.location.href = 'categoria.html';
            });
        });

        $("#btn-registrar-devolucao").on("click", function () {
            let dataHoje = new Date();
            dataHoje = `${dataHoje.getFullYear()}-${(dataHoje.getMonth() + 1).toString().padStart(2, '0')}-${dataHoje.getDate().toString().padStart(2, '0')}`;

            const id = $("#titulo-livro").data('id-emprestimo');
            const API_DEVOLUCAO = `${API_EMPRESTIMO}/${id}/devolucao?data=${dataHoje}`;

            fetch(API_DEVOLUCAO, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    'Authorization': `Bearer ${token}`
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Não foi possível registrar a devolução.');
                }

                $("#btn-registrar-devolucao").addClass("d-none");
                $("#situacao").text("Livro devolvido");
                $("#dias-atraso").text('');
            });
        });
    });
</script>

</body>
</html>
